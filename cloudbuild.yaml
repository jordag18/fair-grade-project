substitutions:
  _DATABASE_URL: "secret://DATABASE_URL"
  _GOOGLE_APPLICATION_CREDENTIALS: "secret://GOOGLE_APPLICATION_CREDENTIALS"
  _AUTH_SECRET: "secret://AUTH_SECRET"
  _AUTH_GITHUB_ID: "secret://AUTH_GITHUB_ID"
  _AUTH_GITHUB_SECRET: "secret://AUTH_GITHUB_SECRET"
  _AUTH_GOOGLE_ID: "secret://AUTH_GOOGLE_ID"
  _AUTH_GOOGLE_SECRET: "secret://AUTH_GOOGLE_SECRET"

steps:
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Fetch secrets from Secret Manager'
  entrypoint: 'sh'
  args:
    - '-c'
    - |
      DATABASE_URL=$(gcloud secrets versions access latest --secret="${_DATABASE_URL}")
      GOOGLE_APPLICATION_CREDENTIALS=$(gcloud secrets versions access latest --secret="${_GOOGLE_APPLICATION_CREDENTIALS}")
      AUTH_SECRET=$(gcloud secrets versions access latest --secret="${_AUTH_SECRET}")
      AUTH_GITHUB_ID=$(gcloud secrets versions access latest --secret="${_AUTH_GITHUB_ID}")
      AUTH_GITHUB_SECRET=$(gcloud secrets versions access latest --secret="${_AUTH_GITHUB_SECRET}")
      AUTH_GOOGLE_ID=$(gcloud secrets versions access latest --secret="${_AUTH_GOOGLE_ID}")
      AUTH_GOOGLE_SECRET=$(gcloud secrets versions access latest --secret="${_AUTH_GOOGLE_SECRET}")

      # Create .env.production file with fetched secrets
      echo "DATABASE_URL=$DATABASE_URL" > .env.production
      echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> .env.production
      echo "AUTH_SECRET=$AUTH_SECRET" >> .env.production
      echo "AUTH_TRUST_HOST=https://fair-grade-app-vpz4vvqzlq-uc.a.run.app" >> .env.production
      echo "NEXTAUTH_URL=https://fair-grade-app-vpz4vvqzlq-uc.a.run.app" >> .env.production
      echo "AUTH_GITHUB_ID=$AUTH_GITHUB_ID" >> .env.production
      echo "AUTH_GITHUB_SECRET=$AUTH_GITHUB_SECRET" >> .env.production
      echo "AUTH_GOOGLE_ID=$AUTH_GOOGLE_ID" >> .env.production
      echo "AUTH_GOOGLE_SECRET=$AUTH_GOOGLE_SECRET" >> .env.production

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker Image'
  args: [
    'build', 
    '-t', 'gcr.io/$PROJECT_ID/fair-grade-app',
    '--build-arg', 'ENV_FILE=.env.production',
    '.'
  ]

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Docker Image'
  args: ['push', 'gcr.io/$PROJECT_ID/fair-grade-app']

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy to Cloud Run'
  entrypoint: gcloud
  args: ['run', 'deploy', 'fair-grade-app', '--image', 'gcr.io/$PROJECT_ID/fair-grade-app', '--region', 'us-central1', '--platform', 'managed', '--allow-unauthenticated']

images:
- 'gcr.io/$PROJECT_ID/fair-grade-app'

logsBucket: gs://744541105758-global-cloudbuild-logs

options:
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET
